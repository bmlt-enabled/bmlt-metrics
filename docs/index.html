<!DOCTYPE html>
<html lang="en-US">
<head>
    <title>Aggregator Meeting Metrics</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" type="text/css" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.19/css/jquery.dataTables.min.css">
    <style>
        table.dataTable tbody, thead {
            font: normal 14px/1.3em "Open Sans", sans-serif;
        }
        .dataTables_wrapper .dataTables_filter {
            float: right;
            text-align: right;
            padding: 6px;
        }
        table.dataTable thead {
            color: #000;
            background-color: #A669B3;
            opacity: 0.9;
        }
        table.dataTable.display tbody tr.odd {
            background-color: #93bddd;
        }
        table.dataTable.display tbody tr.odd > .sorting_1 {
            background-color: #93bddd;
        }
        table.dataTable.display tbody tr.odd:hover {
            background-color: #fff;
        }
        table.dataTable.display tbody tr.odd > .sorting_1:hover {
            background-color: #fff;
        }
        table.dataTable.display tbody tr.even {
            background-color: #D8F3FD;
        }
        table.dataTable.display tbody tr.even:hover {
            background-color: #fff;
        }
        table.dataTable.display tbody tr.even > .sorting_1 {
            background-color: #D8F3FD;
        }
        table.dataTable.display tbody tr.even > .sorting_1:hover {
            background-color: #fff;
        }
        .dataTables_wrapper .dataTables_filter {
            float: right;
            text-align: right;
            padding: 6.7px;
            width: 99%;
            border-radius: 6px 6px 0 0;
            background: linear-gradient(to bottom, #D8F3FD, #0467b1);
        }
    </style>
</head>
<body>
<div id="content" style="width:95%">
    <table id="meetings" class="display">
        <thead>
        <tr>
            <th>DATE</th>
            <th># Meetings</th>
            <th># GROUPS</th>
            <th># AREAS</th>
            <th># REGIONS</th>
            <th># ZONES</th>
        </tr>
        </thead>
    </table>
</div>
<div id="plot" style="width:95%;height:400px;"></div>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
<script src="https://cdn.datatables.net/1.10.16/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
    $(document).ready(function() {
        const currentDate = new Date();
        const startDate1 = '2021-06-28';
        const endDate1 = '2024-03-24';
        const startDate2 = '2024-03-25';
        const endDate2 = currentDate.toISOString().split('T')[0];

        function fetchData(startDate, endDate) {
            return $.ajax({
                url: "https://metrics.api.bmltenabled.org/metrics",
                data: {
                    'start_date': startDate,
                    'end_date': endDate
                },
                dataType: "json",
                type: "GET"
            }).fail(function(jqXHR, textStatus, errorThrown) {
                console.error("Error fetching data: ", textStatus, errorThrown);
            });
        }

        function transformMetricsData(data) {
            return data.Items.map(item => ({
                'date': item.date,
                'num_meetings': item.num_meetings,
                'num_groups': item.num_groups,
                'num_areas': item.num_areas,
                'num_regions': item.num_regions,
                'num_zones': item.num_zones
            }));
        }

        function renderMeetingData(data) {
            const meetingData = data.flat().sort((a, b) => new Date(a.date) - new Date(b.date));

            const trace = {
                x: meetingData.map(item => item.date),
                y: meetingData.map(item => item.num_meetings),
                mode: "lines",
                name: 'Meetings'
            };

            const layout = {
                title: 'Total Meetings in Aggregator',
                showlegend: true
            };

            Plotly.newPlot('plot', [trace], layout, {scrollZoom: true});

            return meetingData;
        }

        const dataPromises = [
            fetchData(startDate1, endDate1).then(transformMetricsData),
            fetchData(startDate2, endDate2).then(transformMetricsData)
        ];

        Promise.all(dataPromises).then(results => {
            const combinedData = results.flat();
            $('#meetings').DataTable({
                columnDefs: [
                    { className: "dt-center", targets: "_all" }
                ],
                language: {
                    search: "",
                    searchPlaceholder: "Search"
                },
                info: false,
                scrollY: "400px",
                paging: false,
                scrollCollapse: true,
                data: renderMeetingData(combinedData),
                columns: [
                    { data: 'date' },
                    { data: 'num_meetings' },
                    { data: 'num_groups' },
                    { data: 'num_areas' },
                    { data: 'num_regions' },
                    { data: 'num_zones' }
                ]
            });
        });
    });
</script>
</body>
</html>
